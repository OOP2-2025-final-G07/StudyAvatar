<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>å‹‰å¼·è¿½åŠ  | Study Avatar</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='base-style.css') }}">
    <style>
        /* ã‚¿ã‚¤ãƒãƒ¼ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .timer-box {
            background-color: #333;
            color: #0f0;
            font-family: 'Courier New', Courier, monospace;
            font-size: 2.5rem;
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: inset 0 0 10px #000;
            letter-spacing: 2px;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒªã‚¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .debug-area {
            background-color: #f0f0f0;
            padding: 15px;
            margin-top: 30px;
            border: 2px dashed #bbb;
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† -->
    <header class="main-header">
        <h1>Study Avatar</h1>
        <nav>
            <ul>
                <li><a href="{{ url_for('index') }}">ãƒ›ãƒ¼ãƒ </a></li>
                <li><a href="{{ url_for('study.new_study') }}">å‹‰å¼·è¨˜éŒ²</a></li>
                <li><a href="{{ url_for('setting.seed_set') }}">è¨­å®š</a></li>
            </ul>
        </nav>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
    <div class="container">
        <div class="record-grid">

            <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¤º -->
            <div class="char-side card">
                <h2>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</h2>
                <div class="avatar-display-large">
                    {% if skin %}
                    <img src="{{ skin }}" alt="Current Avatar" class="avatar-img-large">
                    {% else %}
                    <div class="no-avatar-placeholder">
                        <p>No Image</p>
                    </div>
                    {% endif %}
                </div>
                <div class="char-message">
                    <p>ã€Œé›†ä¸­ã—ã¦é ‘å¼µã‚ã†ï¼ã€</p>
                </div>
            </div>

            <!-- å‹‰å¼·ç™»éŒ²ç”»é¢ -->
            <div class="form-side card">
                <h2>å‹‰å¼·æ™‚é–“ã‚’è¨˜éŒ²ã™ã‚‹</h2>

                {% if error_message %}
                <p style="color: red;">{{ error_message }}</p>
                {% endif %}

                <form action="{{ url_for('study.new_study') }}" method="post" class="study-form"
                    onsubmit="return checkBeforeSubmit();">

                    <!-- <div class="form-group">
                        <label>æ—¥ä»˜</label>
                        <input type="date" name="date" class="form-control">
                    </div> -->

                    <div class="form-group">
                        <label>æ•™ç§‘</label>
                        <select name="subject" class="form-control" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>

                            <optgroup label="ç†ç³»">
                                <option value="æ•°å­¦" {{ 'selected' if form_data.subject=='æ•°å­¦' }}>æ•°å­¦</option>
                                <option value="ç‰©ç†" {{ 'selected' if form_data.subject=='ç‰©ç†' }}>ç‰©ç†</option>
                                <option value="åŒ–å­¦" {{ 'selected' if form_data.subject=='åŒ–å­¦' }}>åŒ–å­¦</option>
                                <option value="ç”Ÿç‰©" {{ 'selected' if form_data.subject=='ç”Ÿç‰©' }}>ç”Ÿç‰©</option>
                                <option value="æƒ…å ±" {{ 'selected' if form_data.subject=='æƒ…å ±' }}>æƒ…å ±</option>
                                <option value="ç†ç³»ãã®ä»–" {{ 'selected' if form_data.subject=='ç†ç³»ãã®ä»–' }}>ç†ç³»ãã®ä»–</option>
                            </optgroup>

                            <optgroup label="æ–‡ç³»">
                                <option value="å›½èª" {{ 'selected' if form_data.subject=='å›½èª' }}>å›½èª</option>
                                <option value="è‹±èª" {{ 'selected' if form_data.subject=='è‹±èª' }}>è‹±èª</option>
                                <option value="æ—¥æœ¬å²" {{ 'selected' if form_data.subject=='æ—¥æœ¬å²' }}>æ—¥æœ¬å²</option>
                                <option value="ä¸–ç•Œå²" {{ 'selected' if form_data.subject=='ä¸–ç•Œå²' }}>ä¸–ç•Œå²</option>
                                <option value="åœ°ç†" {{ 'selected' if form_data.subject=='åœ°ç†' }}>åœ°ç†</option>
                                <option value="æ–‡ç³»ãã®ä»–" {{ 'selected' if form_data.subject=='æ–‡ç³»ãã®ä»–' }}>æ–‡ç³»ãã®ä»–</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
                        <input type="text" name="title" class="form-control" placeholder="ä¾‹: ä¸­é–“ãƒ†ã‚¹ãƒˆå¯¾ç­–" required
                            value="{{ form_data.title if form_data else '' }}">
                    </div>

                    <!-- ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹æ™‚ã®æ—¥ä»˜ï¼ˆé€ä¿¡ç”¨ï¼‰ -->
                    <input type="hidden" name="start_date" id="start_date">
                    <!-- ã‚¿ã‚¤ãƒãƒ¼ãŒé–‹å§‹ã•ã‚ŒãŸã‹ã©ã†ã‹ -->
                    <input type="hidden" name="started" id="started" value="0">
                    <!-- é€ä¿¡ç”¨è¨ˆæ¸¬æ™‚é–“ãƒ‡ãƒ¼ã‚¿ï¼ˆhiddenï¼‰ -->
                    <input type="hidden" name="minutes" id="minutes">

                    <div class="form-group">
                        <label>ã‚¿ã‚¤ãƒ è¨ˆæ¸¬</label>
                        <div class="timer-box">
                            <span id="timer_minutes">00</span> : <span id="timer_seconds">00</span>
                        </div>
                        <div class="timer-controls">
                            <button type="button" class="btn-primary" id="startBtn"
                                style="background-color: #2196F3;">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                            <button type="button" class="btn-primary" id="pauseBtn" disabled
                                style="background-color: #F44336;">ã‚¹ãƒˆãƒƒãƒ—</button>
                            <button type="button" class="btn-primary" id="resumeBtn"
                                style="background-color: #4CAF50;">å†é–‹</button>
                        </div>
                    </div>

                    <!-- <div class="form-group">
                        <label>æ™‚é–“ (åˆ†)</label>
                        <input type="number" name="minutes" id="minutes" class="form-control" placeholder="60" required>
                    </div> -->

                    <div class="form-group">
                        <label>å‚™è€ƒ</label>
                        <textarea name="note" rows="4" class="form-control"
                            placeholder="æ„Ÿæƒ³ãªã©">{{ form_data.note if form_data else '' }}</textarea>
                    </div>

                    <div class="form-actions" style="display: flex; gap: 10px;">
                        <button type="submit" class="btn-primary">
                            è¨˜éŒ²å®Œäº†
                        </button>
                        <button type="button" class="btn-small" onclick="confirmCancel()"
                            style="background: #ccc; border:none; color: #333; width: auto; padding: 12px 20px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>

                    <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">
                    <h3>æœ€è¿‘ã®è¨˜éŒ²ãƒªã‚¹ãƒˆ</h3><!-- ã®ã¡ã«å‰Šé™¤ã—ã€indexã«ç§»å‹•ã•ã›ã¦ãã ã•ã„ -->
                    <div class="table-wrapper" style="max-height: 200px; margin-bottom: 20px;">
                        <table class="log-table">
                            <thead>
                                <tr>
                                    <th>æ—¥ä»˜</th>
                                    <th>æ•™ç§‘</th>
                                    <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
                                    <th>æ™‚é–“</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for study in items %}
                                <tr>
                                    <td>{{ study.date }}</td>
                                    <td>{{ study.subject }}</td>
                                    <td>{{ study.title }}</td>
                                    <td>{{ study.minutes }}åˆ†</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if debug %}
                    <div class="debug-area">
                        <h4 style="margin-top: 0; color: #555;">ğŸ”§ ãƒ‡ãƒãƒƒã‚°ç”¨æ‰‹å…¥åŠ›</h4>
                        <div class="form-group">
                            <label>æ—¥ä»˜ (æ‰‹å‹•): <input type="date" name="debug_date" class="form-control"></label>
                        </div>
                        <div class="form-group">
                            <label>æ™‚é–“ (åˆ†ãƒ»æ‰‹å‹•): <input type="number" name="debug_minutes" min="0"
                                    class="form-control"></label>
                        </div>
                        <p style="color: gray; font-size: 0.8rem;">â€»ã‚¿ã‚¤ãƒãƒ¼ã‚’ä½¿ã‚ãšã€å¼·åˆ¶çš„ã«æ—¥æ™‚ã‚’æŒ‡å®šã—ã¦è¨˜éŒ²ã™ã‚‹å ´åˆã«ä½¿ç”¨ï¼ˆä¸Šã®ç™»éŒ²ãƒœã‚¿ãƒ³ã§é€ä¿¡ã•ã‚Œã¾ã™ï¼‰</p>
                    </div>
                    {% endif %}

                </form>
            </div>
        </div>
    </div>


    <script>
        // ã‚¿ã‚¤ãƒãƒ¼ã®çŠ¶æ³ idle/running/paused
        let timerState = "idle";

        // çŠ¶æ…‹æ›´æ–°
        function setState(state) {
            timerState = state;
            updateButtons();
        }

        // ã‚¹ã‚¿ãƒ¼ãƒˆã€ã‚¹ãƒˆãƒƒãƒ—ã€å†é–‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã®å‡¦ç†
        startBtn.onclick = () => {
            startTimer();
            setState("running");
        };

        pauseBtn.onclick = () => {
            setState("paused");
            stopTimer();
        };

        resumeBtn.onclick = () => {
            setState("running");
            resumeTimer();
        };

        // ãƒœã‚¿ãƒ³ã®å¤‰æ›´
        function updateButtons() {
            startBtn.disabled = (timerState !== "idle");
            pauseBtn.disabled = (timerState !== "running");
            resumeBtn.disabled = (timerState !== "paused");
        }

        // ã‚¿ã‚¤ãƒãƒ¼ã®å‡¦ç†
        let startTime = null;
        let timerInterval = null;
        // ç´¯ç©æ™‚é–“
        let elapsedMs = 0;

        // ã‚¿ã‚¤ãƒãƒ¼ã®å€¤å‡¦ç†
        function timerTick() {
            const diffMs = Date.now() - startTime + elapsedMs;
            const minutes = Math.floor(diffMs / 60000);
            const seconds = Math.floor((diffMs % 60000) / 1000);

            document.getElementById("timer_minutes").textContent =
                String(minutes).padStart(2, "0");
            document.getElementById("timer_seconds").textContent =
                String(seconds).padStart(2, "0");

            document.getElementById("minutes").value = minutes;
        }

        // ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ã—ãŸç¬é–“ã®æ—¥ä»˜ã‚’å–å¾—
        function setStartInfo() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');

            document.getElementById("start_date").value = `${yyyy}-${mm}-${dd}`;
            document.getElementById("started").value = "1";
        }

        // ã‚¿ã‚¤ãƒãƒ¼ã®é–‹å§‹å‡¦ç†
        function startTimer() {
            if (timerInterval !== null) return;

            if (timerState === "idle") {
                elapsedMs = 0;
                setStartInfo();
            }

            startTime = Date.now();
            timerInterval = setInterval(timerTick, 1000);
        }

        // ã‚¿ã‚¤ãƒãƒ¼ã®åœæ­¢å‡¦ç†
        function stopTimer() {
            if (timerInterval !== null) {
                elapsedMs += Date.now() - startTime;
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // ã‚¿ã‚¤ãƒãƒ¼ã®å†é–‹å‡¦ç†
        function resumeTimer() {
            if (timerInterval !== null) return;
            startTime = Date.now();
            timerInterval = setInterval(timerTick, 1000);
        }

        // ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢ã›ãšã«ç™»éŒ²ã™ã‚‹ã¨è­¦å‘Šã‚’è¡¨ç¤º
        function checkBeforeSubmit() {
            if (timerState === "running") {
                alert("ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢ã—ã¦ãã ã•ã„");
                return false;
            }
            return true;
        }

        // æ™‚é–“è¨ˆæ¸¬ã‚’è¡Œã£ãŸå ´åˆã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã«è­¦å‘Šã‚’è¡¨ç¤º
        function confirmCancel() {
            if (timerState !== "idle") {
                if (!confirm("è¨ˆæ¸¬ä¸­ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã™ã€‚ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ")) {
                    return;
                }
            }
            location.href = "{{ url_for('index') }}";
        }

        // åˆæœŸçŠ¶æ…‹ã‚’åæ˜ 
        updateButtons();

    </script>

</body>

</html>