<!-- <!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>å‹‰å¼·è¿½åŠ  | Study Avatar</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='base-style.css') }}">
    <style>
        /* ã‚¿ã‚¤ãƒãƒ¼ã®ãƒ‡ã‚¶ã‚¤ãƒ³ä¿®æ­£ï¼ˆç™½åŸºèª¿ï¼‰ */
        .timer-box {
            background-color: #ffffff; /* ç™½èƒŒæ™¯ */
            color: #333;               /* é»’æ–‡å­— */
            font-family: 'Courier New', Courier, monospace;
            font-size: 3rem;
            text-align: center;
            padding: 25px;
            border-radius: 12px;
            margin: 10px 0;
            border: 2px solid #eee;    /* æŸ”ã‚‰ã‹ã„æ ç·š */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            letter-spacing: 2px;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* ã‚ã‚Šè¾¼ã¿é˜²æ­¢ï¼šãƒ•ã‚©ãƒ¼ãƒ å´ã«ä½™ç™½ã‚’è¿½åŠ  */
        .form-side {
            padding-bottom: 100px; 
            overflow-y: auto;
        }

        .debug-area {
            background-color: #f9f9f9;
            padding: 15px;
            margin-top: 30px;
            border: 1px dashed #ccc;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <h1>Study Avatar</h1>
        <nav>
            <ul>
                <li><a href="{{ url_for('index') }}">ãƒ›ãƒ¼ãƒ </a></li>
                <li><a href="{{ url_for('study.new_study') }}" class="active">å‹‰å¼·è¨˜éŒ²</a></li>
                <li><a href="{{ url_for('setting.seed_set') }}">è¨­å®š</a></li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <div class="record-grid">
            <div class="char-side card">
                <h2>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</h2>
                <div class="avatar-display-large">
                    {% if skin %}
                        <img src="{{ skin }}" alt="Current Avatar" class="avatar-img-large">
                    {% endif %}
                </div>
                <div class="char-message">
                    <p>ã€Œé›†ä¸­ã—ã¦é ‘å¼µã‚ã†ï¼ã€</p>
                </div>
            </div>

            <div class="form-side card">
                <h2>å‹‰å¼·æ™‚é–“ã‚’è¨˜éŒ²ã™ã‚‹</h2>

                {% if error_message %}
                <p style="color: red;">{{ error_message }}</p>
                {% endif %}

                <form action="{{ url_for('study.new_study') }}" method="post" class="study-form" onsubmit="return checkBeforeSubmit();">
                    
                    <div class="form-group">
                        <label>æ•™ç§‘</label>
                        <select name="subject" class="form-control" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <optgroup label="ç†ç³»">
                                <option value="æ•°å­¦">æ•°å­¦</option><option value="ç‰©ç†">ç‰©ç†</option>
                                <option value="åŒ–å­¦">åŒ–å­¦</option><option value="ç”Ÿç‰©">ç”Ÿç‰©</option>
                                <option value="æƒ…å ±">æƒ…å ±</option><option value="ç†ç³»ãã®ä»–">ç†ç³»ãã®ä»–</option>
                            </optgroup>
                            <optgroup label="æ–‡ç³»">
                                <option value="å›½èª">å›½èª</option><option value="è‹±èª">è‹±èª</option>
                                <option value="æ—¥æœ¬å²">æ—¥æœ¬å²</option><option value="ä¸–ç•Œå²">ä¸–ç•Œå²</option>
                                <option value="åœ°ç†">åœ°ç†</option><option value="æ–‡ç³»ãã®ä»–">æ–‡ç³»ãã®ä»–</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
                        <input type="text" name="title" class="form-control" placeholder="ä¾‹: ä¸­é–“ãƒ†ã‚¹ãƒˆå¯¾ç­–" required>
                    </div>

                    <input type="hidden" name="start_date" id="start_date">
                    <input type="hidden" name="started" id="started" value="0">
                    <input type="hidden" name="minutes" id="minutes">

                    <div class="form-group">
                        <label>ã‚¿ã‚¤ãƒ è¨ˆæ¸¬</label>
                        <div class="timer-box">
                            <span id="timer_minutes">00</span> : <span id="timer_seconds">00</span>
                        </div>
                        <div class="timer-controls">
                            <button type="button" class="btn-primary" id="startBtn" style="background-color: #2196F3;">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                            <button type="button" class="btn-primary" id="pauseBtn" disabled style="background-color: #F44336;">ã‚¹ãƒˆãƒƒãƒ—</button>
                            <button type="button" class="btn-primary" id="resumeBtn" style="background-color: #4CAF50;">å†é–‹</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>å‚™è€ƒ</label>
                        <textarea name="note" rows="3" class="form-control" placeholder="æ„Ÿæƒ³ãªã©"></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary">è¨˜éŒ²å®Œäº†</button>
                    </div>

                    {% if debug %}
                    <div class="debug-area">
                        <h4>ğŸ”§ ãƒ‡ãƒãƒƒã‚°ç”¨æ‰‹å…¥åŠ›</h4>
                        <input type="date" name="debug_date" class="form-control" style="margin-bottom:10px;">
                        <input type="number" name="debug_minutes" placeholder="åˆ†" class="form-control">
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>

    <script>
        let timerState = "idle";
        let startTime = null;
        let timerInterval = null;
        let elapsedMs = 0;

        function setState(state) {
            timerState = state;
            startBtn.disabled = (timerState !== "idle");
            pauseBtn.disabled = (timerState !== "running");
            resumeBtn.disabled = (timerState !== "paused");
        }

        startBtn.onclick = () => {
            const today = new Date();
            document.getElementById("start_date").value = today.toISOString().split('T')[0];
            document.getElementById("started").value = "1";
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const diffMs = Date.now() - startTime + elapsedMs;
                const min = Math.floor(diffMs / 60000);
                const sec = Math.floor((diffMs % 60000) / 1000);
                document.getElementById("timer_minutes").textContent = String(min).padStart(2, "0");
                document.getElementById("timer_seconds").textContent = String(sec).padStart(2, "0");
                document.getElementById("minutes").value = min;
            }, 1000);
            setState("running");
        };

        pauseBtn.onclick = () => {
            elapsedMs += Date.now() - startTime;
            clearInterval(timerInterval);
            timerInterval = null;
            setState("paused");
        };

        resumeBtn.onclick = () => {
            startTime = Date.now();
            timerInterval = setInterval(/* åŒä¸Šã®å‡¦ç† */); 
            setState("running");
        };

        function checkBeforeSubmit() {
            if (timerState === "running") { alert("ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢ã—ã¦ãã ã•ã„"); return false; }
            return true;
        }
    </script>
</body>
</html> -->














<!-- 
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>å‹‰å¼·è¿½åŠ  | Study Avatar</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='base-style.css') }}">
    <style>
        /* ã‚¿ã‚¤ãƒãƒ¼ã®ãƒ‡ã‚¶ã‚¤ãƒ³ (ç™½ã£ã½ãä¿®æ­£) */
        .timer-box {
            background-color: #f8f9fa; /* è–„ã„ã‚°ãƒ¬ãƒ¼ */
            color: #333;               /* æ¿ƒã„æ–‡å­— */
            border: 2px solid #ddd;
            font-family: 'Courier New', Courier, monospace;
            font-size: 2.5rem;
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            letter-spacing: 2px;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* è¨˜éŒ²ãƒœã‚¿ãƒ³ã®ã‚ã‚Šè¾¼ã¿ä¿®æ­£ */
        .form-actions {
            margin-top: 30px;
            margin-bottom: 30px;
            padding-bottom: 20px;
        }

        /* ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒªã‚¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .debug-area {
            background-color: #f0f0f0;
            padding: 15px;
            margin-top: 30px;
            border: 2px dashed #bbb;
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <header class="main-header">
        <h1>Study Avatar</h1>
        <nav>
            <ul>
                <li><a href="{{ url_for('index') }}">ãƒ›ãƒ¼ãƒ </a></li>
                <li><a href="{{ url_for('study.new_study') }}" class="active">å‹‰å¼·è¨˜éŒ²</a></li>
                <li><a href="{{ url_for('setting.seed_set') }}">è¨­å®š</a></li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <div class="record-grid">

            <div class="char-side card">
                <h2>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</h2>
                <div class="avatar-display-large">
                    {% if skin %}
                    <img src="{{ skin }}" alt="Current Avatar" class="avatar-img-large">
                    {% else %}
                    <div class="no-avatar-placeholder">
                        <p>No Image</p>
                    </div>
                    {% endif %}
                </div>
                <div class="char-message">
                    <p>ã€Œé›†ä¸­ã—ã¦é ‘å¼µã‚ã†ï¼ã€</p>
                </div>
            </div>

            <div class="form-side card">
                <h2>å‹‰å¼·æ™‚é–“ã‚’è¨˜éŒ²ã™ã‚‹</h2>

                {% if error_message %}
                <p style="color: red;">{{ error_message }}</p>
                {% endif %}

                <form action="{{ url_for('study.new_study') }}" method="post" class="study-form"
                    onsubmit="return checkBeforeSubmit();">

                    <div class="form-group">
                        <label>æ•™ç§‘</label>
                        <select name="subject" class="form-control" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <optgroup label="ç†ç³»">
                                <option value="æ•°å­¦" {{ 'selected' if form_data.subject=='æ•°å­¦' }}>æ•°å­¦</option>
                                <option value="ç‰©ç†" {{ 'selected' if form_data.subject=='ç‰©ç†' }}>ç‰©ç†</option>
                                <option value="åŒ–å­¦" {{ 'selected' if form_data.subject=='åŒ–å­¦' }}>åŒ–å­¦</option>
                                <option value="ç”Ÿç‰©" {{ 'selected' if form_data.subject=='ç”Ÿç‰©' }}>ç”Ÿç‰©</option>
                                <option value="æƒ…å ±" {{ 'selected' if form_data.subject=='æƒ…å ±' }}>æƒ…å ±</option>
                                <option value="ç†ç³»ãã®ä»–" {{ 'selected' if form_data.subject=='ç†ç³»ãã®ä»–' }}>ç†ç³»ãã®ä»–</option>
                            </optgroup>
                            <optgroup label="æ–‡ç³»">
                                <option value="å›½èª" {{ 'selected' if form_data.subject=='å›½èª' }}>å›½èª</option>
                                <option value="è‹±èª" {{ 'selected' if form_data.subject=='è‹±èª' }}>è‹±èª</option>
                                <option value="æ—¥æœ¬å²" {{ 'selected' if form_data.subject=='æ—¥æœ¬å²' }}>æ—¥æœ¬å²</option>
                                <option value="ä¸–ç•Œå²" {{ 'selected' if form_data.subject=='ä¸–ç•Œå²' }}>ä¸–ç•Œå²</option>
                                <option value="åœ°ç†" {{ 'selected' if form_data.subject=='åœ°ç†' }}>åœ°ç†</option>
                                <option value="æ–‡ç³»ãã®ä»–" {{ 'selected' if form_data.subject=='æ–‡ç³»ãã®ä»–' }}>æ–‡ç³»ãã®ä»–</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
                        <input type="text" name="title" class="form-control" placeholder="ä¾‹: ä¸­é–“ãƒ†ã‚¹ãƒˆå¯¾ç­–" required
                            value="{{ form_data.title if form_data else '' }}">
                    </div>

                    <input type="hidden" name="start_date" id="start_date">
                    <input type="hidden" name="started" id="started" value="0">
                    <input type="hidden" name="minutes" id="minutes">

                    <div class="form-group">
                        <label>ã‚¿ã‚¤ãƒ è¨ˆæ¸¬</label>
                        <div class="timer-box">
                            <span id="timer_minutes">00</span> : <span id="timer_seconds">00</span>
                        </div>
                        <div class="timer-controls">
                            <button type="button" class="btn-primary" id="startBtn"
                                style="background-color: #2196F3;">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                            <button type="button" class="btn-primary" id="pauseBtn" disabled
                                style="background-color: #F44336;">ã‚¹ãƒˆãƒƒãƒ—</button>
                            <button type="button" class="btn-primary" id="resumeBtn"
                                style="background-color: #4CAF50;">å†é–‹</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>å‚™è€ƒ</label>
                        <textarea name="note" rows="4" class="form-control"
                            placeholder="æ„Ÿæƒ³ãªã©">{{ form_data.note if form_data else '' }}</textarea>
                    </div>

                    <div class="form-actions" style="display: flex; gap: 10px;">
                        <button type="submit" class="btn-primary">è¨˜éŒ²å®Œäº†</button>
                        <button type="button" class="btn-small" onclick="confirmCancel()"
                            style="background: #ccc; border:none; color: #333; width: auto; padding: 12px 20px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>

                    {% if debug %}
                    <div class="debug-area">
                        <h4 style="margin-top: 0; color: #555;">ğŸ”§ ãƒ‡ãƒãƒƒã‚°ç”¨æ‰‹å…¥åŠ›</h4>
                        <div class="form-group">
                            <label>æ—¥ä»˜: <input type="date" name="debug_date" class="form-control"></label>
                        </div>
                        <div class="form-group">
                            <label>æ™‚é–“(åˆ†): <input type="number" name="debug_minutes" min="0" class="form-control"></label>
                        </div>
                        <p style="color: gray; font-size: 0.8rem;">â€»ã‚¿ã‚¤ãƒãƒ¼ã‚’ä½¿ã‚ãšè¨˜éŒ²ã™ã‚‹å ´åˆã«ä¸Šã®ç™»éŒ²ãƒœã‚¿ãƒ³ã§é€ä¿¡ã—ã¦ãã ã•ã„</p>
                    </div>
                    {% endif %}

                </form>
            </div>
        </div>
    </div>

    <script>
        // --- æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶­æŒ ---
        let timerState = "idle";
        function setState(state) { timerState = state; updateButtons(); }
        startBtn.onclick = () => { startTimer(); setState("running"); };
        pauseBtn.onclick = () => { setState("paused"); stopTimer(); };
        resumeBtn.onclick = () => { setState("running"); resumeTimer(); };
        function updateButtons() {
            startBtn.disabled = (timerState !== "idle");
            pauseBtn.disabled = (timerState !== "running");
            resumeBtn.disabled = (timerState !== "paused");
        }

        let startTime = null;
        let timerInterval = null;
        let elapsedMs = 0;

        function timerTick() {
            const diffMs = Date.now() - startTime + elapsedMs;
            const minutes = Math.floor(diffMs / 60000);
            const seconds = Math.floor((diffMs % 60000) / 1000);
            document.getElementById("timer_minutes").textContent = String(minutes).padStart(2, "0");
            document.getElementById("timer_seconds").textContent = String(seconds).padStart(2, "0");
            document.getElementById("minutes").value = minutes;
        }

        function setStartInfo() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById("start_date").value = `${yyyy}-${mm}-${dd}`;
            document.getElementById("started").value = "1";
        }

        function startTimer() {
            if (timerInterval !== null) return;
            if (timerState === "idle") { elapsedMs = 0; setStartInfo(); }
            startTime = Date.now();
            timerInterval = setInterval(timerTick, 1000);
        }

        function stopTimer() {
            if (timerInterval !== null) {
                elapsedMs += Date.now() - startTime;
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function resumeTimer() {
            if (timerInterval !== null) return;
            startTime = Date.now();
            timerInterval = setInterval(timerTick, 1000);
        }

        function checkBeforeSubmit() {
            if (timerState === "running") { alert("ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢ã—ã¦ãã ã•ã„"); return false; }
            return true;
        }

        function confirmCancel() {
            if (timerState !== "idle") { if (!confirm("è¨ˆæ¸¬ä¸­ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã™ã€‚ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ")) return; }
            location.href = "{{ url_for('index') }}";
        }
        updateButtons();
    </script>
</body>
</html> -->

<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>å‹‰å¼·è¿½åŠ  | Study Avatar</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='base-style.css') }}">
    <style>
        /* æ ã‚µã‚¤ã‚ºçµ±ä¸€ã®ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        .study-form .form-control,
        .study-form .timer-box {
            width: 100%;
            box-sizing: border-box;
        }

        /* å‚™è€ƒï¼ˆtextareaï¼‰ã®å¯å¤‰é•·ã‚’ç„¡åŠ¹åŒ– */
        .study-form textarea.form-control {
            resize: none;
            height: 120px; /* å›ºå®šã®é«˜ã•ã‚’è¨­å®š */
        }

        /* ã‚¿ã‚¤ãƒãƒ¼ã®ãƒ‡ã‚¶ã‚¤ãƒ³ (ç™½ã£ã½ãä¿®æ­£) */
        .timer-box {
            background-color: #f8f9fa; /* è–„ã„ã‚°ãƒ¬ãƒ¼ */
            color: #333;               /* æ¿ƒã„æ–‡å­— */
            border: 2px solid #ddd;
            font-family: 'Courier New', Courier, monospace;
            font-size: 2.5rem;
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            letter-spacing: 2px;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* --- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å¹ãå‡ºã—ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        .char-side {
            text-align: center; /* è¦ç´ ã‚’ä¸­å¤®å¯„ã› */
        }

        .char-message {
            position: relative;
            background-color: #ffffff;
            border: 2px solid #4CAF50; /* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ã®ç·‘ */
            border-radius: 15px;
            padding: 12px 20px;
            margin: 25px auto 0; /* ä¸Šã«ä¸‰è§’ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
            display: inline-block;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.05));
        }

        /* å¹ãå‡ºã—ã®ä¸‰è§’éƒ¨åˆ†ï¼ˆä¸Šå‘ãï¼‰ */
        .char-message::before {
            content: "";
            position: absolute;
            top: -12px;
            left: 50%;
            margin-left: -10px;
            border-style: solid;
            border-width: 0 10px 12px 10px;
            border-color: transparent transparent #4CAF50 transparent;
        }

        .char-message::after {
            content: "";
            position: absolute;
            top: -9px;
            left: 50%;
            margin-left: -9px;
            border-style: solid;
            border-width: 0 9px 11px 9px;
            border-color: transparent transparent #ffffff transparent;
        }

        .char-message p {
            margin: 0;
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
        }
        /* ------------------------------------ */

        /* è¨˜éŒ²ãƒœã‚¿ãƒ³ã®ã‚ã‚Šè¾¼ã¿ä¿®æ­£ */
        .form-actions {
            margin-top: 30px;
            margin-bottom: 30px;
            padding-bottom: 20px;
        }

        /* ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒªã‚¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .debug-area {
            background-color: #f0f0f0;
            padding: 15px;
            margin-top: 30px;
            border: 2px dashed #bbb;
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <header class="main-header">
        <h1>Study Avatar</h1>
        <nav>
            <ul>
                <li><a href="{{ url_for('index') }}">ãƒ›ãƒ¼ãƒ </a></li>
                <li><a href="{{ url_for('study.new_study') }}" class="active">å‹‰å¼·è¨˜éŒ²</a></li>
                <li><a href="{{ url_for('setting.seed_set') }}">è¨­å®š</a></li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <div class="record-grid">

            <div class="char-side card">
                <h2>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</h2>
                <div class="avatar-display-large">
                    {% if skin %}
                    <img src="{{ skin }}" alt="Current Avatar" class="avatar-img-large">
                    {% else %}
                    <div class="no-avatar-placeholder">
                        <p>No Image</p>
                    </div>
                    {% endif %}
                </div>
                <div class="char-message">
                    <p>ã€Œé›†ä¸­ã—ã¦é ‘å¼µã‚ã†ï¼ã€</p>
                </div>
            </div>

            <div class="form-side card">
                <h2>å‹‰å¼·æ™‚é–“ã‚’è¨˜éŒ²ã™ã‚‹</h2>

                {% if error_message %}
                <p style="color: red;">{{ error_message }}</p>
                {% endif %}

                <form action="{{ url_for('study.new_study') }}" method="post" class="study-form"
                    onsubmit="return checkBeforeSubmit();">

                    <div class="form-group">
                        <label>æ•™ç§‘</label>
                        <select name="subject" class="form-control" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <optgroup label="ç†ç³»">
                                <option value="æ•°å­¦" {{ 'selected' if form_data.subject=='æ•°å­¦' }}>æ•°å­¦</option>
                                <option value="ç‰©ç†" {{ 'selected' if form_data.subject=='ç‰©ç†' }}>ç‰©ç†</option>
                                <option value="åŒ–å­¦" {{ 'selected' if form_data.subject=='åŒ–å­¦' }}>åŒ–å­¦</option>
                                <option value="ç”Ÿç‰©" {{ 'selected' if form_data.subject=='ç”Ÿç‰©' }}>ç”Ÿç‰©</option>
                                <option value="æƒ…å ±" {{ 'selected' if form_data.subject=='æƒ…å ±' }}>æƒ…å ±</option>
                                <option value="ç†ç³»ãã®ä»–" {{ 'selected' if form_data.subject=='ç†ç³»ãã®ä»–' }}>ç†ç³»ãã®ä»–</option>
                            </optgroup>
                            <optgroup label="æ–‡ç³»">
                                <option value="å›½èª" {{ 'selected' if form_data.subject=='å›½èª' }}>å›½èª</option>
                                <option value="è‹±èª" {{ 'selected' if form_data.subject=='è‹±èª' }}>è‹±èª</option>
                                <option value="æ—¥æœ¬å²" {{ 'selected' if form_data.subject=='æ—¥æœ¬å²' }}>æ—¥æœ¬å²</option>
                                <option value="ä¸–ç•Œå²" {{ 'selected' if form_data.subject=='ä¸–ç•Œå²' }}>ä¸–ç•Œå²</option>
                                <option value="åœ°ç†" {{ 'selected' if form_data.subject=='åœ°ç†' }}>åœ°ç†</option>
                                <option value="æ–‡ç³»ãã®ä»–" {{ 'selected' if form_data.subject=='æ–‡ç³»ãã®ä»–' }}>æ–‡ç³»ãã®ä»–</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
                        <input type="text" name="title" class="form-control" placeholder="ä¾‹: ä¸­é–“ãƒ†ã‚¹ãƒˆå¯¾ç­–" required
                            value="{{ form_data.title if form_data else '' }}">
                    </div>

                    <input type="hidden" name="start_date" id="start_date">
                    <input type="hidden" name="started" id="started" value="0">
                    <input type="hidden" name="minutes" id="minutes">

                    <div class="form-group">
                        <label>ã‚¿ã‚¤ãƒ è¨ˆæ¸¬</label>
                        <div class="timer-box">
                            <span id="timer_minutes">00</span> : <span id="timer_seconds">00</span>
                        </div>
                        <div class="timer-controls">
                            <button type="button" class="btn-primary" id="startBtn"
                                style="background-color: #2196F3;">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                            <button type="button" class="btn-primary" id="pauseBtn" disabled
                                style="background-color: #F44336;">ã‚¹ãƒˆãƒƒãƒ—</button>
                            <button type="button" class="btn-primary" id="resumeBtn"
                                style="background-color: #4CAF50;">å†é–‹</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>å‚™è€ƒ</label>
                        <textarea name="note" rows="4" class="form-control"
                            placeholder="æ„Ÿæƒ³ãªã©">{{ form_data.note if form_data else '' }}</textarea>
                    </div>

                    <div class="form-actions" style="display: flex; gap: 10px;">
                        <button type="submit" class="btn-primary">è¨˜éŒ²å®Œäº†</button>
                        <button type="button" class="btn-small" onclick="confirmCancel()"
                            style="background: #ccc; border:none; color: #333; width: auto; padding: 12px 20px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>

                    {% if debug %}
                    <div class="debug-area">
                        <h4 style="margin-top: 0; color: #555;">ğŸ”§ ãƒ‡ãƒãƒƒã‚°ç”¨æ‰‹å…¥åŠ›</h4>
                        <div class="form-group">
                            <label>æ—¥ä»˜: <input type="date" name="debug_date" class="form-control"></label>
                        </div>
                        <div class="form-group">
                            <label>æ™‚é–“(åˆ†): <input type="number" name="debug_minutes" min="0" class="form-control"></label>
                        </div>
                        <p style="color: gray; font-size: 0.8rem;">â€»ã‚¿ã‚¤ãƒãƒ¼ã‚’ä½¿ã‚ãšè¨˜éŒ²ã™ã‚‹å ´åˆã«ä¸Šã®ç™»éŒ²ãƒœã‚¿ãƒ³ã§é€ä¿¡ã—ã¦ãã ã•ã„</p>
                    </div>
                    {% endif %}

                </form>
            </div>
        </div>
    </div>

    <script>
        // --- æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶­æŒ ---
        let timerState = "idle";
        function setState(state) { timerState = state; updateButtons(); }
        startBtn.onclick = () => { startTimer(); setState("running"); };
        pauseBtn.onclick = () => { setState("paused"); stopTimer(); };
        resumeBtn.onclick = () => { setState("running"); resumeTimer(); };
        function updateButtons() {
            startBtn.disabled = (timerState !== "idle");
            pauseBtn.disabled = (timerState !== "running");
            resumeBtn.disabled = (timerState !== "paused");
        }

        let startTime = null;
        let timerInterval = null;
        let elapsedMs = 0;

        function timerTick() {
            const diffMs = Date.now() - startTime + elapsedMs;
            const minutes = Math.floor(diffMs / 60000);
            const seconds = Math.floor((diffMs % 60000) / 1000);
            document.getElementById("timer_minutes").textContent = String(minutes).padStart(2, "0");
            document.getElementById("timer_seconds").textContent = String(seconds).padStart(2, "0");
            document.getElementById("minutes").value = minutes;
        }

        function setStartInfo() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById("start_date").value = `${yyyy}-${mm}-${dd}`;
            document.getElementById("started").value = "1";
        }

        function startTimer() {
            if (timerInterval !== null) return;
            if (timerState === "idle") { elapsedMs = 0; setStartInfo(); }
            startTime = Date.now();
            timerInterval = setInterval(timerTick, 1000);
        }

        function stopTimer() {
            if (timerInterval !== null) {
                elapsedMs += Date.now() - startTime;
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function resumeTimer() {
            if (timerInterval !== null) return;
            startTime = Date.now();
            timerInterval = setInterval(timerTick, 1000);
        }

        function checkBeforeSubmit() {
            if (timerState === "running") { alert("ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢ã—ã¦ãã ã•ã„"); return false; }
            return true;
        }

        function confirmCancel() {
            if (timerState !== "idle") { if (!confirm("è¨ˆæ¸¬ä¸­ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã™ã€‚ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ")) return; }
            location.href = "{{ url_for('index') }}";
        }
        updateButtons();
    </script>
</body>
</html>