<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>勉強追加</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='base-style.css') }}">
</head>

<body>
    <h1>勉強を追加</h1>

    <!-- パンくず(削除予定) -->
    <ul class="breadcrumb">
        <li><a href="{{ url_for('index') }}">HOME</a></li>
        <li>新しい勉強</li>
    </ul>

    <!-- 入力フォーム -->
    <form action="{{ url_for('study.new_study') }}" method="post">

        <label>タイトル: <input type="text" name="title" required></label><br>
        <label>備考:<br><textarea name="note" rows="4" cols="40"></textarea></label><br>
        <label>
            教科:
            <select name="subject" required>
                <option value="">選択してください</option>
                <!-- 理系 -->
                <option value="数学">数学</option>
                <option value="物理">物理</option>
                <option value="化学">化学</option>
                <option value="生物">生物</option>
                <option value="情報">情報</option>
                <option value="理系その他">理系その他</option>

                <!-- 文系 -->
                <option value="国語">国語</option>
                <option value="英語">英語</option>
                <option value="日本史">日本史</option>
                <option value="世界史">世界史</option>
                <option value="地理">地理</option>
                <option value="文系その他">文系その他</option>
            </select>
        </label><br>

        <!-- タイマー開始時の日付（送信用） -->
        <input type="hidden" name="start_date" id="start_date">
        <!-- タイマーが開始されたかどうか -->
        <input type="hidden" name="started" id="started" value="0">

        <!-- 表示用タイマー（ユーザーが見るもの） -->
        <p>経過時間: <span id="timer_minutes">00</span> : <span id="timer_seconds">00</span></p>
        <!-- 送信用計測時間データ（hidden） -->
        <input type="hidden" name="minutes" id="minutes">

        <button type="button" onclick="startTimer()">スタート</button>
        <button type="button" onclick="stopTimer()">ストップ</button>

        <!-- デバッグ時の手入力欄 -->
        {% if debug %}
        <hr>
        <h4>【デバッグ用入力】</h4>

        <label>日付（手入力）:<input type="date" name="debug_date"></label><br>
        <label>時間（分・手入力）:<input type="number" name="debug_minutes" min="0"></label><br>

        <p style="color: gray;">※ debug=True のときのみ表示されます。また、タイマーを動かしていないときは必ず両方の値を入力してください</p>
        {% endif %}

        <!-- 
            76行目の url_for は Flask(Jinja2) のテンプレート構文です。
            VSCode上では JavaScript の構文エラーとして表示されることがありますが、
            実行上は問題ありません。
        -->
        <button type="submit">登録</button>
        <button type="button" onclick="location.href='{{ url_for('index') }}'">
            キャンセル
        </button>
    </form>

    <!-- 一覧表示 -->
    <br>
    <table>
        <tbody>
            {% for study in items %}
            <tr>
                <td>内容:{{ study.title }}</td>
                <td>時間:{{ study.minutes }}分</td>
                <td>備考:{{ study.note }}</td>
                <td>教科:{{ study.subject }}</td>
                <td>日付:{{ study.date }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- タイマー -->
    <script>
        let startTime = null;
        let timerInterval = null;

        function startTimer() {
            // すでに動いていたら二重起動しない
            if (timerInterval !== null) return;

            // スタート時の日付を記録
            startTime = Date.now();
            // スタート時の日付をセット（YYYY-MM-DD）
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');

            document.getElementById("start_date").value = `${yyyy}-${mm}-${dd}`;
            document.getElementById("started").value = "1";


            // 時間の計測
            timerInterval = setInterval(() => {
                const diffMs = Date.now() - startTime;
                const minutes = Math.floor(diffMs / 60000);
                const seconds = Math.floor((diffMs % 60000) / 1000);

                document.getElementById("timer_minutes").textContent = String(minutes).padStart(2, "0");
                document.getElementById("timer_seconds").textContent = String(seconds).padStart(2, "0");
                document.getElementById("minutes").value = minutes;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }
    </script>

</body>

</html>